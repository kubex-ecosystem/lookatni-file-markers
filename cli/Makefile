# üöÄ LookAtni CLI - Makefile
# Seguindo filosofia Kubex: "Um comando = um resultado"

.PHONY: build clean install test help

# Vari√°veis
BINARY_NAME=lookatni
BUILD_DIR=bin
VERSION=$(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
LDFLAGS=-ldflags "-X main.version=$(VERSION)"
GITHUB_REF=$(shell echo $$GITHUB_REF)
MAIN_COMMIT=$(shell git rev-parse --short HEAD 2>/dev/null || echo "unknown")
MAIN_DATE=$(shell date +%Y-%m-%d)
MAIN_PKG_PATH=$(shell go list -m)

# Comando padr√£o
help: ## Mostra esta ajuda
	@echo "üöÄ LookAtni CLI - Build System"
	@echo "=============================="
	@echo "Comandos dispon√≠veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

build: ## Compila o CLI Go
	@echo "üî® Compilando LookAtni CLI..."
	@mkdir -p $(BUILD_DIR)
	go build -ldflags "-s -w -X main.version=$(GITHUB_REF#refs/tags/) -X main.commit=$(MAIN_COMMIT) -X main.date=$(MAIN_DATE)" -trimpath -o $(BUILD_DIR)/$(BINARY_NAME) ./cmd/main.go
	@upx --best --lzma $(BUILD_DIR)/$(BINARY_NAME) --no-progress --no-color -qqq || true
	@echo "‚úÖ Build completo: $(BUILD_DIR)/$(BINARY_NAME)"

clean: ## Remove arquivos de build
	@echo "üßπ Limpando arquivos de build..."
	rm -rf $(BUILD_DIR)
	@echo "‚úÖ Limpeza completa!"

install: build ## Instala o CLI globalmente
	@echo "üì¶ Instalando LookAtni CLI globalmente..."
	sudo cp $(BUILD_DIR)/$(BINARY_NAME) /usr/local/bin/
	@echo "‚úÖ Instalado em /usr/local/bin/$(BINARY_NAME)"
	@echo "üí° Use: lookatni --help"

test: build ## Testa o CLI
	@echo "üß™ Testando LookAtni CLI..."
	./$(BUILD_DIR)/$(BINARY_NAME) version
	./$(BUILD_DIR)/$(BINARY_NAME) --help
	@echo "‚úÖ Testes b√°sicos OK!"

dev: ## Build e teste r√°pido para desenvolvimento
	@echo "‚ö° Build desenvolvimento..."
	go build $(LDFLAGS) -o $(BINARY_NAME) ./cmd/main.go
	./$(BINARY_NAME) version
	@echo "‚úÖ Dev build OK!"

# Build cross-platform
build-all: ## Compila para m√∫ltiplas plataformas
	@echo "üåç Compilando para m√∫ltiplas plataformas..."
	@mkdir -p $(BUILD_DIR)
	GOOS=linux GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-linux-amd64 ./cmd/main.go
	GOOS=darwin GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-darwin-amd64 ./cmd/main.go
	GOOS=windows GOARCH=amd64 go build $(LDFLAGS) -o $(BUILD_DIR)/$(BINARY_NAME)-windows-amd64.exe ./cmd/main.go
	@echo "‚úÖ Build cross-platform completo!"
	@ls -la $(BUILD_DIR)/

.DEFAULT_GOAL := help
